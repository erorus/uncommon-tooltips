const BNet = require('./battlenet');
const Tooltip = require('./tooltip');
const Locales = require('./locales');

const wait = function(ms) { return new Promise(function(resolve) { setTimeout(resolve, ms) })};

const IconPath = 'https://render-us.worldofwarcraft.com/icons/56/';
const CraftingReagents = [723,765,769,774,783,785,814,818,1015,1080,1206,1210,1288,1468,1475,1529,1705,2251,2318,2319,2320,2321,2324,2325,2447,2449,2450,2452,2453,2589,2592,2604,2605,2672,2673,2674,2675,2677,2678,2770,2771,2772,2775,2776,2835,2836,2838,2840,2841,2842,2880,2886,2924,2934,2996,2997,3164,3173,3182,3355,3356,3357,3358,3369,3371,3404,3466,3470,3478,3486,3575,3576,3577,3667,3685,3712,3730,3731,3818,3819,3820,3821,3857,3858,3859,3860,3864,4231,4232,4233,4234,4235,4236,4289,4291,4304,4305,4306,4337,4338,4339,4340,4341,4342,4357,4359,4364,4371,4375,4377,4382,4387,4389,4399,4400,4402,4404,4461,4470,4603,4611,4625,4655,5051,5082,5373,5465,5466,5467,5468,5469,5470,5471,5498,5500,5503,5504,5635,5637,5784,5785,6037,6260,6261,6289,6291,6303,6308,6317,6358,6359,6361,6362,6370,6371,6470,6471,6889,7067,7068,7069,7070,7071,7072,7075,7076,7077,7078,7079,7080,7081,7082,7191,7286,7392,7909,7910,7911,7912,7966,7971,7972,7974,8150,8153,8154,8165,8167,8169,8170,8171,8172,8343,8365,8831,8836,8838,8839,8845,8846,9060,9061,9210,9262,10285,10286,10290,10505,10558,10559,10560,10561,10620,10647,10938,10939,10940,10978,10998,11082,11083,11084,11134,11135,11137,11138,11139,11174,11175,11176,11177,11178,11291,11370,11371,11382,11754,12037,12184,12202,12203,12204,12205,12206,12207,12208,12223,12359,12360,12361,12363,12364,12365,12607,12644,12655,12662,12799,12800,12803,12804,12808,12809,12810,12811,12938,13422,13423,13463,13464,13465,13466,13467,13468,13754,13756,13757,13758,13759,13760,13888,13889,13926,14047,14048,14227,14256,14341,14342,14343,14344,15407,15408,15410,15412,15414,15415,15416,15417,15419,15992,15994,16000,16006,16202,16203,16204,17010,17011,17012,17056,17194,17203,18240,18335,18562,18567,18631,19441,19767,19768,19943,20381,20424,20520,20725,20816,20817,20963,21024,21071,21153,21752,21840,21842,21844,21845,21877,21881,21882,21884,21885,21886,21887,21929,22202,22203,22445,22446,22447,22448,22449,22450,22451,22452,22456,22457,22572,22573,22574,22575,22576,22577,22578,22644,22682,22785,22786,22787,22789,22790,22791,22792,22793,22794,23077,23079,23107,23112,23117,23424,23425,23426,23427,23436,23437,23438,23439,23440,23441,23445,23446,23447,23448,23449,23571,23572,23573,23676,23781,23782,23783,23784,23785,23786,23787,23793,24243,24271,24272,24477,24478,24479,25649,25699,25700,25707,25708,25867,25868,27422,27425,27429,27435,27437,27438,27439,27515,27516,27668,27669,27671,27674,27677,27678,27681,27682,29539,29547,29548,30183,30817,31079,31670,31671,32227,32228,32229,32230,32231,32249,32423,32428,33470,33567,33568,33823,33824,34052,34053,34054,34055,34056,34057,34664,34736,35128,35562,35622,35623,35624,35625,35627,36782,36783,36784,36860,36901,36903,36904,36905,36906,36907,36908,36909,36910,36912,36913,36916,36917,36918,36919,36920,36921,36922,36923,36924,36925,36926,36927,36928,36929,36930,36931,36932,36933,36934,37663,37700,37701,37702,37703,37704,37705,37921,38425,38426,38557,38558,38561,39151,39334,39338,39339,39340,39341,39342,39343,39354,39469,39681,39682,39683,39684,39690,39774,39970,40195,40199,40533,41163,41266,41334,41510,41511,41593,41594,41595,41800,41801,41802,41803,41805,41806,41807,41808,41809,41810,41812,41813,41814,42225,42253,43007,43009,43010,43011,43012,43013,43102,43103,43104,43105,43106,43107,43108,43109,43115,43116,43117,43118,43119,43120,43121,43122,43123,43124,43125,43126,43127,43501,44128,44499,44500,44501,44834,44835,44853,44958,45087,47556,49908,51950,52078,52177,52178,52179,52180,52181,52182,52183,52185,52186,52188,52190,52191,52192,52193,52194,52195,52196,52303,52325,52326,52327,52328,52329,52555,52718,52719,52720,52721,52722,52976,52977,52979,52980,52982,52983,52984,52985,52986,52987,52988,53010,53038,53039,53062,53063,53064,53065,53066,53067,53068,53069,53070,53071,53072,53643,54440,54849,56516,56850,58480,60224,61978,61979,61980,61981,62323,62778,62779,62780,62781,62782,62783,62784,62785,62786,62791,65365,65892,65893,67229,67319,67335,67749,69237,71805,71806,71807,71808,71809,71810,71998,72092,72093,72094,72095,72096,72103,72104,72120,72162,72163,72234,72235,72237,72238,72988,74247,74248,74249,74250,74251,74252,74659,74660,74661,74662,74832,74833,74834,74837,74838,74839,74840,74841,74842,74843,74844,74845,74846,74847,74848,74849,74850,74851,74852,74853,74854,74856,74857,74859,74860,74861,74863,74864,74865,74866,75014,76061,76130,76131,76132,76133,76134,76135,76136,76137,76138,76139,76140,76141,76142,76734,77467,77468,79010,79011,79101,79246,79250,79251,79253,79254,79255,79731,80433,82441,82447,83064,83092,85506,85583,85584,85585,87399,87828,89112,89639,90146,90407,90636,94111,94113,94289,97512,97546,97619,97620,97621,97622,97623,97624,98617,98619,98717,102218,102536,102537,102538,102539,102540,102541,102542,102543,107473,108042,108043,108255,108256,108257,108294,108295,108296,108297,108298,108299,108300,108301,108302,108303,108304,108305,108306,108307,108308,108309,108318,108319,108320,108321,108322,108323,108324,108325,108326,108327,108328,108329,108330,108331,108332,108333,108334,108335,108336,108337,108338,108339,108340,108341,108342,108343,108344,108345,108346,108347,108348,108349,108350,108351,108352,108353,108354,108355,108356,108357,108358,108359,108360,108361,108362,108363,108364,108365,108391,108996,109088,109096,109097,109098,109099,109100,109101,109102,109103,109104,109105,109106,109118,109119,109123,109124,109125,109126,109127,109128,109129,109130,109131,109132,109133,109134,109135,109136,109137,109138,109139,109140,109141,109142,109143,109144,109624,109625,109626,109627,109628,109629,109693,109991,109992,110609,110610,110611,110661,111245,111366,111556,111557,111589,111595,111601,111650,111651,111652,111656,111658,111659,111662,111663,111664,111665,111666,111667,111668,111669,111670,111671,111672,111673,111674,111675,111676,111849,112155,112156,112157,112158,112177,112178,112179,112180,112181,112182,112183,112184,112185,112377,112379,113111,113261,113262,113263,113264,113588,113589,114781,114931,114999,115002,115502,115504,115508,115524,116053,118472,119810,119813,119814,119815,119817,119819,120945,123918,123919,124101,124102,124103,124104,124105,124106,124107,124108,124109,124110,124111,124112,124113,124115,124116,124117,124118,124119,124120,124121,124122,124123,124124,124436,124437,124438,124439,124440,124441,124442,124444,124461,124632,124669,127004,127037,127681,127759,128304,128499,128500,129032,129034,129100,129284,129285,129286,129287,129288,129289,130172,130173,130174,130175,130176,130177,130178,130179,130180,130181,130182,130183,130245,133588,133589,133590,133591,133592,133593,133607,133680,133912,135500,136342,136533,136534,136538,136633,136636,136637,136638,137595,137596,137597,137609,138296,140781,140782,140783,140784,140785,142266,142335,142336,144329,151564,151565,151566,151567,151568,151579,151718,151719,151720,151721,151722];
const Toys = [1973,13379,17712,17716,18660,18984,18986,21540,23767,30542,30544,30690,32542,32566,32782,33079,33219,33223,33927,34480,34499,34686,35227,35275,36862,36863,37254,37460,37710,38301,38578,40727,40768,40895,43499,43824,44430,44606,44719,44820,45011,45013,45014,45015,45016,45017,45018,45019,45020,45021,45057,45063,45984,46709,46780,46843,48933,49703,49704,50471,52201,52253,53057,54212,54343,54437,54438,54452,54651,54653,60854,63141,63269,64358,64361,64373,64383,64456,64481,64482,64488,64646,64651,64881,64997,66888,67097,68806,69215,69227,69775,69776,69777,69895,69896,70159,70161,70722,71137,71259,71628,72159,72161,72220,72221,72222,72223,72224,72225,72226,72227,72228,72229,72230,72231,72232,72233,75042,79769,80822,82467,85500,85973,86565,86568,86571,86573,86575,86578,86581,86582,86583,86584,86586,86588,86589,86590,86593,86594,86596,87214,87215,87528,88370,88375,88377,88381,88385,88387,88417,88531,88566,88579,88580,88584,88587,88589,88801,88802,89139,89205,89222,89614,89869,89999,90000,90067,90175,90427,90883,90888,90899,91904,92738,93672,95567,95568,95589,95590,97919,97921,97942,97994,98132,98136,98552,101571,102467,103685,104262,104294,104302,104309,104318,104323,104324,104329,104331,105898,108631,108632,108633,108634,108635,108735,108739,108743,108745,109167,109183,109739,110586,111476,111821,112059,112324,113096,113375,113540,113542,113543,113570,113631,113670,114227,115468,115472,115503,115506,116067,116113,116115,116120,116122,116125,116139,116400,116435,116440,116456,116651,116689,116690,116691,116692,116757,116758,116763,116856,116888,116889,116890,116891,117550,117569,117573,118191,118221,118222,118224,118244,118427,118716,118935,118937,118938,119001,119003,119039,119083,119092,119093,119134,119144,119145,119160,119163,119178,119180,119182,119210,119211,119212,119215,119217,119218,119219,119220,119221,119421,119432,120276,120857,122117,122119,122120,122121,122122,122123,122126,122129,122283,122293,122298,122304,122674,122681,122700,123851,126931,127394,127652,127655,127659,127666,127668,127669,127670,127695,127696,127707,127709,127766,127859,127864,128223,128310,128328,128462,128471,128536,128636,128776,128794,128807,129045,129055,129057,129093,129111,129113,129149,129165,129211,129279,129367,129926,129929,129938,129952,129956,129958,129960,129961,129965,130102,130147,130151,130157,130158,130169,130170,130171,130191,130194,130199,130209,130214,130232,130249,130251,130254,131724,131811,131812,131814,131900,131933,132518,133511,133542,133997,133998,134004,134007,134019,134020,134021,134022,134023,134024,134026,134031,134032,134034,134831,136846,136849,136855,136927,136928,136934,136935,136937,137294,137663,138202,138415,138490,138873,138876,138878,138900,139337,139587,139773,140160,140231,140309,140314,140324,140325,140336,140363,140632,140779,140780,140786,141296,141297,141298,141299,141300,141301,141306,141331,141649,141862,141879,142265,142341,142360,142452,142494,142495,142496,142497,142528,142529,142530,142531,142532,142536,142542,143534,143543,143544,143545,143660,143662,143727,143827,143828,143829,144072,144339,144393,147307,147308,147309,147310,147311,147312,147537,147708,147832,147838,147843,147867,150547,150743,150744,150745,150746,151016,151184,151265,151270,151271,151343,151344,151348,151349,151652,151877,152556,152574,152982,153004,153039,153124,153126,153179,153180,153181,153182,153183,153193,153194,153204,153253,153293];
const Species = {"444":1352,"2671":39,"7380":44,"7381":45,"7382":43,"7383":42,"7384":41,"7385":40,"7386":46,"7387":50,"7389":51,"7390":47,"7391":49,"7394":52,"7395":55,"7543":56,"7544":58,"7545":59,"7546":1563,"7547":57,"7549":65,"7550":64,"7553":68,"7554":69,"7555":67,"7560":72,"7561":74,"7562":77,"7565":75,"7567":78,"8376":83,"9656":85,"9657":86,"9662":87,"10259":89,"10598":90,"11325":92,"11326":93,"11327":94,"12419":95,"14421":70,"14755":757,"14756":758,"14878":106,"15186":107,"15358":111,"15361":1168,"15429":114,"15698":119,"15699":116,"15705":120,"15706":118,"15710":117,"16069":121,"16085":122,"16445":1073,"16456":124,"16547":125,"16548":126,"16549":127,"16701":128,"17254":1927,"17255":130,"18381":131,"18839":132,"20408":136,"20472":137,"21008":140,"21009":139,"21010":138,"21018":141,"21055":142,"21056":145,"21063":144,"21064":143,"21076":146,"22445":149,"22943":153,"23198":155,"23231":157,"23234":156,"23258":158,"23266":159,"23274":160,"23909":162,"24388":163,"24389":164,"24480":165,"24753":166,"24968":191,"25062":167,"25109":168,"25110":169,"25146":170,"25147":171,"25706":172,"26050":173,"26056":174,"26119":175,"27217":179,"27346":180,"27914":183,"28470":186,"28513":187,"28883":188,"29089":189,"29147":190,"29726":192,"30379":84,"31575":193,"32589":194,"32590":195,"32591":197,"32592":196,"32595":198,"32643":199,"32791":200,"32818":201,"32841":202,"32939":203,"33188":204,"33194":205,"33197":206,"33198":207,"33200":209,"33205":212,"33219":210,"33226":211,"33227":213,"33238":214,"33239":216,"33274":215,"33529":226,"33530":225,"33578":217,"33810":218,"33975":1943,"34278":220,"34364":224,"34587":227,"34694":228,"34724":229,"34770":1351,"34930":231,"35387":235,"35394":239,"35395":233,"35396":232,"35397":237,"35398":238,"35399":236,"35400":234,"35468":240,"36482":241,"36511":242,"36607":243,"36871":244,"36908":245,"36909":246,"36910":247,"36911":248,"36979":249,"37865":250,"38374":251,"40198":253,"40295":254,"40624":255,"40703":256,"40721":257,"42078":258,"42177":259,"42183":260,"43800":261,"43916":262,"45128":264,"45247":265,"45340":266,"46896":268,"46898":267,"47944":270,"48107":271,"48242":272,"48609":277,"48641":278,"48982":279,"49586":280,"49587":282,"49588":281,"49590":283,"50468":285,"50545":292,"50586":286,"50722":293,"51090":291,"51122":294,"51600":297,"51601":296,"51632":287,"51635":289,"51649":298,"52226":301,"52343":302,"52344":303,"52831":306,"52894":307,"53048":308,"53225":309,"53232":310,"53283":311,"53623":316,"53658":317,"53661":318,"53884":319,"54027":320,"54128":321,"54227":323,"54374":325,"54383":328,"54438":329,"54487":335,"54491":330,"54539":331,"54541":332,"54730":333,"54745":665,"55187":336,"55215":337,"55356":338,"55367":339,"55386":340,"55571":341,"55574":342,"56031":343,"56082":344,"56083":345,"56266":346,"58163":347,"59020":348,"59216":354,"59358":848,"59702":727,"60649":374,"61071":419,"61080":378,"61081":379,"61086":381,"61087":382,"61088":383,"61089":384,"61141":386,"61142":387,"61143":385,"61158":388,"61160":389,"61165":447,"61167":391,"61168":392,"61169":424,"61170":394,"61171":395,"61253":396,"61255":397,"61257":398,"61258":399,"61259":400,"61312":401,"61313":403,"61314":421,"61317":404,"61318":405,"61319":406,"61320":407,"61321":408,"61322":409,"61323":410,"61324":411,"61325":635,"61326":414,"61327":412,"61328":415,"61329":416,"61366":417,"61367":418,"61368":648,"61369":420,"61370":402,"61372":422,"61375":439,"61383":423,"61384":393,"61385":425,"61386":429,"61420":427,"61425":428,"61438":430,"61439":431,"61440":432,"61441":433,"61443":438,"61456":434,"61459":437,"61677":633,"61686":509,"61689":440,"61690":441,"61691":442,"61703":445,"61704":443,"61708":444,"61718":446,"61750":390,"61751":448,"61752":449,"61753":450,"61755":640,"61757":452,"61758":453,"61826":456,"61827":628,"61828":627,"61829":626,"61830":457,"61877":845,"61883":846,"61889":454,"61890":455,"61892":2,"61905":458,"62019":459,"62020":460,"62022":461,"62034":463,"62035":462,"62050":464,"62051":465,"62114":466,"62115":467,"62116":468,"62117":470,"62118":469,"62119":471,"62120":472,"62121":473,"62127":631,"62129":474,"62130":475,"62163":476,"62176":477,"62177":478,"62178":479,"62181":480,"62182":838,"62184":482,"62185":483,"62186":484,"62187":485,"62188":486,"62189":487,"62190":488,"62191":506,"62201":489,"62242":507,"62246":493,"62250":508,"62255":505,"62256":492,"62257":491,"62258":494,"62312":495,"62313":496,"62314":497,"62315":498,"62316":499,"62317":500,"62364":632,"62370":502,"62373":503,"62375":504,"62395":557,"62434":510,"62435":634,"62523":511,"62524":512,"62526":513,"62555":514,"62564":515,"62583":517,"62620":518,"62621":519,"62625":638,"62626":375,"62627":521,"62628":528,"62638":637,"62640":523,"62641":644,"62648":525,"62664":646,"62669":529,"62693":641,"62695":639,"62697":530,"62815":649,"62816":532,"62818":647,"62819":534,"62820":535,"62829":847,"62835":536,"62852":537,"62854":538,"62864":558,"62884":539,"62885":540,"62886":541,"62887":755,"62888":547,"62892":542,"62893":543,"62894":851,"62895":544,"62896":545,"62899":546,"62900":548,"62904":549,"62905":550,"62906":645,"62907":823,"62914":552,"62915":837,"62916":756,"62921":553,"62922":554,"62924":555,"62925":556,"62927":559,"62953":560,"62954":675,"62991":562,"62992":380,"62994":564,"62997":565,"62998":566,"62999":567,"63001":568,"63002":569,"63003":570,"63004":571,"63005":572,"63006":573,"63057":711,"63060":713,"63062":706,"63064":707,"63094":708,"63095":709,"63096":710,"63097":629,"63098":630,"63288":716,"63291":717,"63293":723,"63304":678,"63358":712,"63365":650,"63370":1042,"63547":726,"63548":745,"63549":733,"63550":724,"63551":725,"63555":731,"63557":729,"63558":730,"63559":652,"63585":728,"63621":821,"63715":699,"63716":703,"63724":666,"63832":671,"63838":748,"63841":749,"63842":750,"63847":751,"63849":752,"63850":747,"63919":702,"63953":680,"63954":739,"63957":740,"64232":820,"64238":744,"64242":742,"64246":677,"64248":679,"64334":873,"64335":872,"64352":743,"64632":835,"64633":836,"64634":834,"64804":741,"64899":844,"65029":705,"65054":714,"65099":715,"65124":718,"65185":722,"65187":732,"65190":737,"65203":746,"65215":753,"65216":754,"65313":802,"65314":792,"65321":819,"65323":817,"65324":818,"65344":800,"65659":874,"65660":875,"65661":876,"65662":880,"65664":881,"65665":882,"65668":877,"65675":886,"65676":887,"65677":885,"65825":825,"65826":826,"65827":829,"65828":830,"65829":824,"65830":827,"65831":828,"65832":832,"65833":831,"65834":833,"66104":849,"66105":850,"66144":889,"66145":890,"66154":891,"66155":892,"66156":893,"66329":894,"66330":895,"66331":896,"66333":897,"66334":898,"66335":899,"66361":904,"66363":905,"66364":906,"66375":900,"66376":901,"66377":902,"66414":924,"66416":925,"66417":926,"66427":907,"66428":908,"66429":909,"66438":911,"66439":912,"66443":921,"66444":922,"66445":923,"66450":856,"66453":915,"66454":916,"66455":917,"66468":927,"66469":928,"66470":929,"66481":931,"66482":932,"66483":933,"66485":934,"66486":935,"66487":936,"66488":937,"66489":938,"66490":939,"66491":855,"66492":941,"66493":942,"66494":943,"66495":944,"66496":945,"66497":946,"66498":947,"66499":948,"66500":949,"66531":950,"66532":951,"66533":952,"66534":953,"66535":954,"66536":955,"66537":956,"66538":957,"66539":958,"66540":959,"66541":960,"66542":961,"66543":962,"66544":963,"66545":964,"66613":965,"66614":966,"66615":967,"66616":968,"66618":969,"66619":970,"66620":971,"66624":974,"66626":975,"66627":976,"66628":977,"66629":978,"66631":979,"66709":992,"66710":993,"66711":994,"66712":998,"66713":999,"66714":1000,"66715":995,"66716":996,"66718":997,"66719":1001,"66720":1002,"66721":1003,"66722":1007,"66723":1008,"66724":1009,"66725":1010,"66726":1011,"66728":1012,"66802":983,"66804":984,"66805":985,"66806":980,"66807":981,"66808":982,"66809":986,"66810":987,"66811":988,"66812":989,"66813":990,"66814":991,"66923":1004,"66925":1005,"66926":1006,"66930":888,"66950":868,"66964":878,"66965":879,"66966":913,"66982":883,"66983":884,"66984":903,"66996":972,"66997":973,"67022":1013,"67230":1039,"67233":1040,"67319":1061,"67329":1062,"67332":1063,"67382":1066,"67383":1067,"67384":1065,"67443":1068,"68267":1117,"68466":1124,"68467":1125,"68468":1126,"68502":1127,"68506":1128,"68555":1129,"68558":1187,"68559":1188,"68560":1189,"68561":1190,"68562":1191,"68563":1192,"68564":1193,"68565":1194,"68566":1195,"68567":1130,"68568":1131,"68569":1132,"68570":1133,"68571":1136,"68572":1134,"68573":1137,"68575":1135,"68577":1138,"68578":1141,"68579":1140,"68580":1139,"68601":1142,"68654":1146,"68655":1145,"68656":1143,"68657":1144,"68658":1156,"68659":1155,"68660":1154,"68661":1151,"68662":1152,"68663":1153,"68664":1149,"68665":1147,"68666":1150,"68804":1157,"68805":1158,"68806":1159,"68819":1160,"68820":1161,"68838":1162,"68839":1163,"68841":1164,"68845":1165,"68846":1166,"68850":1167,"69208":1174,"69648":1175,"69649":1176,"69748":1177,"69778":1178,"69794":1179,"69796":1180,"69818":1181,"69819":1182,"69820":1183,"69848":1185,"69849":1184,"69891":1196,"69892":1198,"69893":1197,"70082":1204,"70083":1200,"70098":1201,"70144":1202,"70154":1205,"70257":1206,"70258":1207,"70259":1208,"70260":1209,"70451":1211,"70452":1212,"70453":1213,"71014":1226,"71015":1227,"71016":1228,"71017":1230,"71018":1231,"71019":1232,"71020":1233,"71021":1234,"71022":1235,"71023":1236,"71033":1229,"71159":1237,"71163":1238,"71199":1243,"71200":1244,"71201":1245,"71438":1247,"71488":1248,"71655":1255,"71693":1256,"71700":1257,"71816":1258,"71844":1259,"71897":1288,"71898":1286,"71942":1266,"72009":1267,"72053":1268,"72054":1269,"72055":1271,"72097":1287,"72098":1278,"72099":1279,"72100":1277,"72101":1282,"72102":1281,"72103":1280,"72104":1284,"72105":1283,"72106":1285,"72107":1291,"72108":1290,"72109":1289,"72110":1292,"72111":1293,"72112":1295,"72113":1296,"72114":1297,"72115":1298,"72116":1300,"72117":1301,"72118":1299,"72160":1276,"72285":1311,"72290":1319,"72291":1317,"72462":1303,"72463":1304,"72464":1305,"73011":1320,"73350":1331,"73351":1332,"73352":1322,"73354":1334,"73355":1333,"73356":1328,"73357":1335,"73359":1338,"73364":1330,"73366":1337,"73367":1336,"73368":1326,"73532":1329,"73533":1323,"73534":1321,"73542":1324,"73543":1325,"73627":1339,"73668":1343,"73688":1344,"73730":1345,"73732":1346,"73738":1348,"73741":1349,"73809":1350,"73977":1354,"74402":1363,"74405":1364,"74413":1365,"76873":1384,"77021":1385,"77137":1386,"77221":1387,"78421":1394,"78895":1395,"79039":1396,"79180":1400,"79181":1401,"79182":1402,"79410":1403,"79730":1453,"79751":1409,"80017":1410,"80101":1411,"80329":1412,"81431":1416,"81594":1420,"82045":1447,"82406":1423,"82407":1424,"82464":1426,"82715":1427,"83562":1428,"83583":1430,"83584":1429,"83588":1434,"83589":1431,"83592":1433,"83594":1432,"83642":1441,"83817":1442,"83836":1444,"83839":1443,"84330":1446,"84441":1448,"84521":1449,"84853":1569,"84885":1450,"84915":1451,"85003":1457,"85005":1455,"85007":1456,"85009":1454,"85014":1458,"85192":1469,"85231":1515,"85253":1464,"85254":1463,"85255":1462,"85257":1465,"85281":1571,"85283":1466,"85284":1467,"85387":1471,"85388":1468,"85389":1470,"85419":1472,"85420":1473,"85463":1474,"85522":1475,"85523":1476,"85525":1477,"85527":1478,"85561":1479,"85652":1480,"85655":1482,"85656":1483,"85657":1484,"85658":1485,"85659":1486,"85660":1487,"85661":1488,"85662":1489,"85663":1490,"85664":1492,"85665":1493,"85666":1494,"85667":1495,"85674":1496,"85675":1497,"85676":1498,"85677":1499,"85678":1500,"85679":1503,"85680":1502,"85681":1501,"85682":1504,"85683":1505,"85684":1506,"85685":1507,"85686":1508,"85687":1509,"85688":1510,"85710":1511,"85773":1514,"85798":1573,"85846":1516,"85872":1517,"85994":1518,"86061":1521,"86067":1523,"86081":1524,"86420":1531,"86422":1530,"86445":115,"86447":1532,"86532":1533,"86715":1536,"86716":1537,"86717":1538,"86718":1539,"86719":1540,"86879":1541,"87111":1542,"87257":1543,"87669":1544,"87704":1545,"87705":1546,"87946":1549,"87947":1548,"87952":1547,"87967":1553,"87968":1552,"87970":1550,"87972":1556,"87975":1554,"87976":1555,"87978":1557,"87979":1558,"87980":1559,"87981":1562,"87982":1561,"87983":1560,"88103":1564,"88134":1565,"88222":1566,"88225":1567,"88300":1568,"88355":1593,"88356":1592,"88357":1591,"88359":1590,"88367":1570,"88385":1572,"88401":1574,"88413":1589,"88415":1588,"88417":1587,"88422":1586,"88452":1575,"88465":1583,"88466":1582,"88473":1581,"88474":1579,"88480":1578,"88490":1576,"88514":1577,"88542":1761,"88571":1594,"88572":1595,"88573":1596,"88574":1597,"88575":1598,"88576":1599,"88577":1600,"88692":1601,"88805":1602,"88807":1603,"88814":1604,"88830":1605,"89129":1608,"89130":1607,"89131":1609,"89135":1610,"89194":1615,"89198":1435,"90200":1622,"90201":1623,"90202":1624,"90203":1625,"90204":1626,"90205":1627,"90206":1628,"90207":1629,"90208":1631,"90212":1632,"90213":1633,"90214":1634,"90215":1635,"90345":1636,"90676":1637,"90929":1652,"91226":1639,"91335":1640,"91336":1641,"91337":1642,"91338":1643,"91339":1644,"91340":1645,"91341":1646,"91342":1647,"91343":1648,"91344":1649,"91345":1651,"91346":1653,"91347":1654,"91407":1655,"91408":1656,"91823":1660,"93142":1661,"93143":1662,"93352":1663,"93483":1664,"93808":1665,"93814":1666,"94601":1671,"94623":1672,"94637":1673,"94638":1674,"94639":1675,"94640":1676,"94641":1677,"94642":1678,"94643":1679,"94644":1680,"94645":1681,"94646":1682,"94647":1683,"94648":1684,"94649":1685,"94650":1686,"94867":1687,"94927":1688,"95572":1690,"95841":1691,"96123":1693,"96126":1692,"96403":1699,"96404":1700,"96405":1701,"96622":1705,"96649":1706,"97018":1708,"97076":1709,"97078":1710,"97079":1711,"97080":1712,"97118":1713,"97126":1714,"97127":1715,"97128":1716,"97174":1717,"97178":1718,"97179":1719,"97205":1721,"97206":1722,"97207":1720,"97229":1725,"97236":1726,"97238":1727,"97283":1728,"97294":1729,"97323":1731,"97324":1730,"97511":1734,"97531":1735,"97542":1736,"97547":1737,"97555":1738,"97559":1739,"97568":1741,"97569":1740,"97690":1742,"97741":1743,"97743":1744,"97818":1745,"97823":1746,"97826":1748,"97840":1749,"97952":1750,"98004":1751,"98077":1752,"98116":1753,"98128":1754,"98132":1755,"98172":1756,"98181":1757,"98182":1758,"98183":1759,"98185":1760,"98192":1762,"98211":1763,"98236":1764,"98237":1766,"98238":1765,"98294":1770,"98295":1771,"98296":1772,"98385":1773,"98386":1774,"98428":1775,"98446":1776,"98463":1777,"98506":1778,"98572":1811,"98592":1782,"98593":1781,"98595":1780,"99015":1789,"99016":1788,"99017":1787,"99084":1792,"99085":1790,"99086":1791,"99151":1794,"99156":1793,"99158":1798,"99185":1796,"99186":1795,"99187":1797,"99239":1800,"99243":1801,"99245":1799,"99389":1803,"99394":1802,"99403":1804,"99425":1805,"99505":1806,"99513":1807,"99526":1808,"99527":1809,"99528":1810,"99742":1815,"99856":1816,"99874":1817,"99876":1818,"103159":1828,"104558":1840,"104559":1841,"104560":1842,"104782":1843,"104972":1846,"104975":1847,"104978":1848,"104992":1849,"105009":1850,"105086":1853,"105087":1852,"105090":1851,"105241":1855,"105260":1857,"105261":1858,"105262":1859,"105318":1860,"105319":1861,"105320":1862,"105353":1863,"105355":1865,"105356":1864,"105389":1866,"105391":1867,"105452":1870,"105453":1868,"105454":1869,"105499":1871,"105500":1872,"105675":1873,"105677":1874,"105678":1875,"105782":1877,"105783":1878,"105784":1879,"105840":1880,"105841":1881,"105842":1882,"105898":1883,"106152":1884,"106181":1885,"106210":1886,"106232":1887,"106270":1888,"106278":1889,"106283":1890,"106417":1891,"106422":1892,"106423":1893,"106424":1894,"106525":1895,"106535":1896,"106553":1897,"106554":1898,"106555":1899,"107206":1903,"107491":1904,"107492":1905,"107493":1906,"108568":1907,"109216":1911,"110666":1912,"110741":1913,"110826":1914,"111158":1915,"111172":1917,"111202":1918,"111296":1919,"111421":1922,"111423":1921,"111425":1920,"111984":1926,"112015":1723,"112132":1928,"112144":1929,"112167":1930,"112728":1931,"112798":1932,"112945":1933,"113136":1934,"113440":1935,"113527":1936,"113827":1937,"113855":1938,"113983":1940,"113984":1939,"114063":1941,"114064":1519,"114543":1949,"115135":1952,"115136":1953,"115137":1954,"115138":1955,"115139":1956,"115140":1957,"115141":1958,"115142":1959,"115143":1960,"115144":1961,"115145":1962,"115146":1963,"115147":1964,"115148":1965,"115149":1966,"115150":1967,"115152":1968,"115158":1969,"115306":1972,"115308":1971,"115313":1973,"115784":1974,"115785":1975,"115786":1976,"115787":1977,"115918":1978,"115919":1979,"116077":1981,"116078":1982,"116079":1983,"116080":1984,"116786":1989,"116787":1987,"116788":1988,"116789":1990,"116790":1991,"116791":1992,"116792":1993,"116793":1994,"116794":1995,"116795":1996,"116871":1997,"117180":1998,"117182":1999,"117184":2000,"117340":2001,"117341":2002,"117343":2003,"117371":2004,"117979":2008,"117980":2009,"117981":2010,"117982":2011,"117983":2012,"117985":2013,"117986":2014,"117987":2015,"117988":2016,"118060":2017,"118063":2018,"119040":2022,"119341":2028,"119342":2027,"119343":2026,"119344":2025,"119345":2024,"119346":2023,"119407":2032,"119408":2033,"119409":2031,"119498":2035,"119499":2036,"119500":2037,"119754":2038,"119756":2039,"119760":2040,"119794":2041,"120397":2042,"120591":2046,"120830":2047,"120973":2048,"121317":2049,"121715":2050,"122033":2051,"122612":2057,"122629":2058,"123329":2061,"123650":2062,"124389":2063,"124589":2064,"124594":2065,"124632":2066,"124633":2067,"124634":2068,"124858":2071,"124944":2072,"126579":2077,"127850":2078,"127852":2079,"127853":2080,"127857":2081,"127858":2082,"127859":2083,"127862":2084,"127863":2085,"127947":2086,"127948":2087,"127950":2088,"127951":2089,"127952":2090,"127953":2091,"127954":2092,"127956":2093,"128007":2095,"128008":2096,"128009":2097,"128010":2098,"128011":2099,"128012":2100,"128013":2101,"128014":2102,"128015":2103,"128016":2104,"128017":2105,"128018":2106,"128019":2107,"128020":2108,"128021":2109,"128022":2112,"128023":2111,"128024":2110,"128118":2115,"128119":2116,"128137":2117,"128146":2113,"128156":2114,"128157":2118,"128158":2119,"128159":2120,"128160":2121,"128162":2123,"128163":2122,"128164":2124,"128166":2127,"128167":2134,"128168":2129,"128170":2128,"128171":2130,"128172":2131,"128173":2133,"128174":2132,"128175":2126,"128388":2135,"128396":2136};

const DomainToLocale = {
    'www': 'en_US',
    'de': 'de_DE',
    'es': 'es_ES',
    'fr': 'fr_FR',
    'it': 'it_IT',
    'pt': 'pt_BR',
    'ru': 'ru_RU',
    'ko': 'ko_KR',
};

const AcceptableTypes = ['item','npc'];

function paramWalk(str) {
    var t = this;
    var re = /\b([a-zA-Z0-9\.-]+)=([a-zA-Z0-9\.-]+)/g;

    var k, v;

    var results;
    while (results = re.exec(str)) {
        k = results[1].toLowerCase();
        v = results[2];

        if (AcceptableTypes.indexOf(k) >= 0) {
            continue;
        }

        t[k] = v;
    }
}

Tooltip.setLinkResolver(function(a) {
    var result;
    var details = {};
    var rel = a.rel ? a.rel : '';
    if (a.dataset && a.dataset.wowhead) {
        rel = a.dataset.wowhead;
    } else if (a.getAttribute && a.getAttribute('data-wowhead')) {
        rel = a.getAttribute('data-wowhead');
    }

    if (/^np\b/.test(rel)) {
        return false;
    }

    if (result = a.href.match(new RegExp('^https?://(?:([^\.]+)\.)?wowhead\.com/(' + AcceptableTypes.join('|') + ')=(\\d+)', 'i'))) {
        details.domain = result[1];
        details.type = result[2];
        details.id = result[3];

        paramWalk.call(details, a.href);
    }

    if (result = rel.match(new RegExp('\\b(' + AcceptableTypes.join('|') + ')=(\\d+)', 'i'))) {
        details.type = result[1];
        details.id = result[2];
    }
    paramWalk.call(details, rel);

    if (!details.domain) {
        details.domain = 'www';
    }
    details.locale = DomainToLocale[details.domain.toLowerCase()] || 'en_US';

    if (details.type == 'item') {
        return getItem(details);
    }
    if (details.type == 'npc' && Species.hasOwnProperty(details.id)) {
        details.npc = details.id;
        details.type = 'species';
        details.id = Species[details.npc];
        return getSpecies(details);
    }

    return false;
});

function getItem(details) {
    return BNet.GetItem(details.locale, details.id).then(function(item) {
        details.itemSetLookup = {};

        var promises = [];
        if (item.itemSet && item.itemSet.items) {
            for (var x in item.itemSet.items) {
                if (!item.itemSet.items.hasOwnProperty(x)) {
                    continue;
                }
                if (item.itemSet.items[x] == item.id) {
                    details.itemSetLookup[item.id] = item;
                    continue;
                }
                promises.push(BNet.GetItem(details.locale, item.itemSet.items[x]));
            }
        }

        return Promise.all(promises).then(function(responses) {
            for (var x in responses) {
                if (!responses.hasOwnProperty(x)) {
                    continue;
                }
                if (!responses[x].hasOwnProperty('id')) {
                    continue;
                }
                details.itemSetLookup[responses[x].id] = responses[x];
            }
            return buildItemTooltip(details, item);
        })
    });
}

function getSpecies(details) {
    return BNet.GetSpecies(details.locale, details.id).then(buildSpeciesTooltip.bind(null, details));
}

function formatNumber(locale, num, decimals) {
    if (locale) {
        locale = locale.replace(/_/g, '-');
    }
    if (!decimals) {
        decimals = 0;
    }
    return num.toLocaleString(locale, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals,
    });
}

function buildSpeciesTooltip(details, json) {
    Locales.setLocale(details.locale);
    var l = Locales.dictionary();

    var s, x, y, top = document.createElement('div');

    if (!json.speciesId) {
        var reason = json.reason || 'Unable to get species information';
        top.appendChild(makeSpan(reason));
        return top;
    }

    if (json.icon) {
        var i = document.createElement('div');
        i.className = 'icon';
        i.style.backgroundImage = "url('" + IconPath + encodeURIComponent(json.icon) + ".jpg')";
        top.appendChild(i);
    }

    top.appendChild(makeSpan(json.name, 'name q'));

    s = makeSpan(l.battlePet);
    if (l.petFamilyMap.hasOwnProperty(json.petTypeId)) {
        s.appendChild(makeSpan(l.petFamilyMap[json.petTypeId], 'right'));
    }
    top.appendChild(s);

    if (!json.canBattle) {
        top.appendChild(makeSpan(l.cannotBattle, 'red'));
    }

    if (json.description) {
        top.appendChild(document.createElement('br'));
        top.appendChild(makeSpan('"' + json.description + '"', 'q'));
    }

    return top;
}

function buildItemTooltip(details, json) {
    Locales.setLocale(details.locale);
    var l = Locales.dictionary();
    var Format = formatNumber.bind(null, details.locale);

    console.log(details, json);

    var s, x, y, top = document.createElement('div');

    if (!json.id) {
        var reason = json.reason || 'Unable to get item information';
        top.appendChild(makeSpan(reason));
        return top;
    }

    if (json.icon) {
        var i = document.createElement('div');
        i.className = 'icon';
        i.style.backgroundImage = "url('" + IconPath + encodeURIComponent(json.icon) + ".jpg')";
        top.appendChild(i);
    }

    top.appendChild(makeSpan(json.name, 'name q' + json.quality));

    if (json.nameDescription) {
        s = makeSpan(json.nameDescription);
        if (json.nameDescriptionColor) {
            s.style.color = '#' + json.nameDescriptionColor;
        }
        top.appendChild(s);
    }

    if (json.itemClass == 16 && l.classMap.hasOwnProperty(json.itemSubClass)) { // glyph
        top.appendChild(makeSpan(l.classMap[json.itemSubClass]));
    }

    if (json.itemLevel && [2,4].indexOf(json.itemClass) >= 0) {
        top.appendChild(makeSpan(l.itemLevel + ' ' + json.itemLevel, 'level'));
    }

    // upgrade level - not in json(?) always upgradable=true

    // conjured - not in json

    if (l.itemBindMap.hasOwnProperty(json.itemBind)) {
        // binds on battle.net account looks like BoP
        top.appendChild(makeSpan(l.itemBindMap[json.itemBind]));
    }

    if (json.maxCount) {
        top.appendChild(makeSpan(l.unique + (json.maxCount > 1 ? ' (' + json.maxCount + ')' : '')));
    }

    if (Toys.indexOf(json.id) >= 0) {
        top.appendChild(makeSpan(l.toy, 'blue'));
    }

    if (json.itemClass == 15 && json.itemSubClass == 5) {
        top.appendChild(makeSpan(l.mount));
    }

    // begins a quest - not in json

    if (l.inventoryTypeMap.hasOwnProperty(json.inventoryType)) {
        var subType = '' + json.itemClass + '-' + json.itemSubClass;
        if (json.inventoryType == 18 && json.containerSlots) { // bag
            top.appendChild(makeSpan(json.containerSlots + ' ' + l.slot + ' ' +
                (l.inventorySubtypeMap.hasOwnProperty(subType) ? l.inventorySubtypeMap[subType] : l.inventoryTypeMap[json.inventoryType])
            ));
        } else {
            s = makeSpan(l.inventoryTypeMap[json.inventoryType]);
            if (l.inventorySubtypeMap.hasOwnProperty(subType)) {
                s.appendChild(makeSpan(l.inventorySubtypeMap[subType], 'right'));
            }
            top.appendChild(s);
        }
    }

    if (json.weaponInfo) {
        s = makeSpan('' + Format(json.weaponInfo.damage.min) + ' - ' + Format(json.weaponInfo.damage.max) + ' ' + l.damage);
        s.appendChild(makeSpan(l.speed + ' ' + Format(json.weaponInfo.weaponSpeed, 2), 'right'));
        top.appendChild(s);
        top.appendChild(makeSpan('(' + Format(json.weaponInfo.dps, 2) + ' ' + l.damagePerSecond + ')'));
    }

    if (json.armor) {
        top.appendChild(makeSpan(Format(json.armor) + ' ' + l.armor));
    }

    var statsOrders = [
        [4, 3, 5, 71, 72, 73, 74, 7, 1, 0, 8, 9, 2, 10],
        [12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 41, 43, 44, 45, 46, 47, 48, 49, 50, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 6],
        [56, 51, 55, 52, 54, 53],
        ];
    var statsLists = [[],[],[]];

    var allResistWatch = {
        '56': 0,
        '51': 0,
        '55': 0,
        '52': 0,
        '54': 0,
    };

    for (y = 0; y < json.bonusStats.length; y++) {
        if (allResistWatch.hasOwnProperty(json.bonusStats[y].stat)) {
            allResistWatch[json.bonusStats[y].stat] += json.bonusStats[y].amount;
        }
        statsLists[statsLists.length - 1].push(json.bonusStats[y]);
        for (x = 0; x < statsOrders.length; x++) {
            if (statsOrders[x].indexOf(json.bonusStats[y].stat) >= 0) {
                statsLists[x].push(json.bonusStats[y]);
                statsLists[statsLists.length - 1].pop();
                break;
            }
        }
    }

    var allResistAmount = allResistWatch['56'];
    for (x in allResistWatch) {
        if (!allResistWatch.hasOwnProperty(x)) {
            continue;
        }
        if (allResistAmount != allResistWatch[x]) {
            allResistAmount = false;
            break;
        }
    }
    if (allResistAmount) {
        for (x = 0; x < statsLists[2].length; x++) {
            if (allResistWatch.hasOwnProperty(statsLists[2][x].stat)) {
                statsLists[2].splice(x--, 1);
            }
        }
    }

    var statComparitor = function(order,a,b) {
        var apos = order.indexOf(a.stat);
        var bpos = order.indexOf(b.stat);

        if (apos < 0) {
            return 1;
        }
        if (bpos < 0) {
            return -1;
        }

        return apos < bpos ? -1 : 1;
    };

    var stat;
    for (x = 0; x < statsLists.length; x++) {
        statsLists[x].sort(statComparitor.bind(null, statsOrders[x]));
        for (y = 0; stat = statsLists[x][y]; y++) {
            top.appendChild(makeSpan((stat.amount >= 0 ? '+' : '-') + Format(stat.amount) + ' ' + l.itemStatMap[stat.stat], x == 1 ? 'q2' : ''));
        }
    }
    if (allResistAmount) {
        top.appendChild(makeSpan((allResistAmount >= 0 ? '+' : '-') + Format(allResistAmount) + ' ' + l.allResistances));
    }

    // todo: enchants

    if (json.socketInfo && json.socketInfo.sockets) {
        top.appendChild(document.createElement('br'));

        for (x = 0; x < json.socketInfo.sockets.length; x++) {
            y = json.socketInfo.sockets[x].type;
            if (!y) {
                continue;
            }
            y = y.toLowerCase().replace(/[^a-z0-9]/g, '');

            s = makeSpan(false, 'q0');
            top.appendChild(s);
            s.appendChild(Tooltip.createSocket(y));
            if (l.relicSlotMap.hasOwnProperty(y)) {
                s.appendChild(document.createTextNode(l.relicSlotMap[y] + ' ' + l.relicSlot));
            } else if (l.socketMap.hasOwnProperty(y)) {
                s.appendChild(document.createTextNode(l.socketMap[y] + ' ' + l.socket));
            } else {
                s.appendChild(document.createTextNode(y));
            }
            top.appendChild(s);
        }

        if (json.socketInfo.socketBonus) {
            top.appendChild(makeSpan(l.socketBonus + ': ' + json.socketInfo.socketBonus, 'q0'));
        }
        top.appendChild(document.createElement('br'));
    }

    if (json.maxDurability) {
        top.appendChild(makeSpan(l.durability + ' ' + json.maxDurability + ' / ' + json.maxDurability));
    }

    if (json.itemSpells) {
        var spellText = '';
        for (x in json.itemSpells) {
            if (!json.itemSpells.hasOwnProperty(x) || !json.itemSpells[x].spell) {
                continue;
            }
            if (json.itemSpells[x].trigger == 'ON_LEARN') {
                continue;
            }

            if (!json.itemSpells[x].spell.description) {
                if (json.itemSpells[x].trigger == 'ON_USE' && json.description) {
                    json.itemSpells[x].spell.description = json.description;
                    json.description = '';
                } else {
                    continue;
                }
            }

            spellText = '';
            spellText += (l.spellTriggerMap.hasOwnProperty(json.itemSpells[x].trigger) ? l.spellTriggerMap[json.itemSpells[x].trigger] : json.itemSpells[x].trigger) + ': ';
            spellText += json.itemSpells[x].spell.description;

            top.appendChild(makeSpan(spellText, 'q2'));

            if (json.itemSpells[x].nCharges > 1) {
                top.appendChild(makeSpan('' + json.itemSpells[x].nCharges + ' ' + l.charges));
            }

            // recipe reagents 24307 47654 - not in json
        }
    }

    if (json.allowableRaces && json.allowableRaces.length) {
        var allSet = {};
        allSet[l.alliance + ' ' + l.only] = [1,3,4,7,11,22,25];
        allSet[l.horde + ' ' + l.only] = [2,5,6,8,9,10,26];
        top.appendChild(allowList(json.allowableRaces, l.raceMap, 'Race', l.races, allSet));
    }

    if (json.allowableClasses && json.allowableClasses.length) {
        top.appendChild(allowList(json.allowableClasses, l.classMap, 'Class', l.classes));
    }

    if (json.requiredLevel > 1) {
        top.appendChild(makeSpan(l.requiresLevel + ' ' + json.requiredLevel));
    }

    if (json.requiredSkill) {
        top.appendChild(makeSpan(l.requires + ' ' + l.skillMap[json.requiredSkill] + ' (' + json.requiredSkillRank + ')'));
    }

    if (json.requiredAbility && json.requiredAbility.name) {
        top.appendChild(makeSpan(l.requires + ' ' + json.requiredAbility.name));
    }

    if (json.minFactionId && json.minReputation && l.factionMap.hasOwnProperty(json.minFactionId)) {
        top.appendChild(makeSpan(l.requires + ' ' + l.factionMap[json.minFactionId] + ' - ' + l.reputationMap[json.minReputation]));
    }

    if (json.description) {
        top.appendChild(makeSpan('"' + json.description + '"', 'q'));
    }

    if (CraftingReagents.indexOf(json.id) >= 0) {
        top.appendChild(makeSpan(l.craftingReagent, 'blue'));
    }

    if (json.itemSet && json.itemSet.name) {
        top.appendChild(document.createElement('br'));
        top.appendChild(makeSpan(json.itemSet.name, 'q'));

        s = document.createElement('div');
        s.className = 'itemset-items q0';
        top.appendChild(s);
        for (x in json.itemSet.items) {
            if (!json.itemSet.items.hasOwnProperty(x)
                || !details.itemSetLookup.hasOwnProperty(json.itemSet.items[x])
                || !details.itemSetLookup[json.itemSet.items[x]].name) {
                continue;
            }
            s.appendChild(makeSpan(details.itemSetLookup[json.itemSet.items[x]].name));
        }

        if (json.itemSet.setBonuses) {
            top.appendChild(document.createElement('br'));
            for (x in json.itemSet.setBonuses) {
                if (!json.itemSet.setBonuses.hasOwnProperty(x) || !json.itemSet.setBonuses[x].description) {
                    continue;
                }
                top.appendChild(makeSpan('(' + json.itemSet.setBonuses[x].threshold + ') ' + l['set'] + ': ' + json.itemSet.setBonuses[x].description, 'q0'));
            }
        }
    }

    return top;
}

function allowList(jsonList, map, name, prompt, allSet) {
    var s, x, y;
    var raceMap = {}, races = [];

    for (x = 0; x < jsonList.length; x++) {
        if (map.hasOwnProperty(jsonList[x])) {
            raceMap[map[jsonList[x]]] = jsonList[x];
        } else {
            raceMap[name + ' #' + jsonList[x]] = jsonList[x];
        }
        if (allSet) {
            for (y in allSet) {
                if (!allSet.hasOwnProperty(y)) {
                    continue;
                }
                if (allSet[y].indexOf(jsonList[x]) >= 0) {
                    allSet[y].splice(allSet[y].indexOf(jsonList[x]), 1);
                }
            }
        }
    }

    if (allSet) {
        for (y in allSet) {
            if (!allSet.hasOwnProperty(y)) {
                continue;
            }
            if (allSet[y].length == 0) {
                return makeSpan(y, 'nobr');
            }
        }
    }

    for (x in raceMap) {
        if (!raceMap.hasOwnProperty(x)) {
            continue;
        }
        races.push(x);
    }

    races.sort(function(a,b){
        return raceMap[a] < raceMap[b] ? -1 : 1;
    });

    s = makeSpan(prompt ? prompt + ': ' : '');
    for (x = 0; x < races.length; x++) {
        if (x > 0) {
            s.appendChild(document.createTextNode(', '));
        }
        s.appendChild(makeSpan(races[x], 'nobr' + (name == 'Class' ? ' c' + raceMap[races[x]] : '')));
    }

    return s;
}

function makeSpan(txt, cls) {
    var s = document.createElement('span');
    if (txt) {
        s.appendChild(document.createTextNode(txt));
    }
    if (cls) {
        s.className = cls;
    }
    return s;
}

var ranSetup = false;
function setupAfterLoad() {
    if (ranSetup) {
        return;
    }
    ranSetup = true;

    Tooltip.init();
}

window.uncommonTooltips = {
    init: function(info) {
        if (typeof info == 'string') {
            BNet.SetKey(info);
        } else if (info.hasOwnProperty('key')) {
            BNet.SetKey(info.key);
        } else {
            return false;
        }

        if (document.readyState === "interactive" || document.readyState === "complete") {
            setupAfterLoad();
        } else {
            window.addEventListener('load', setupAfterLoad);
        }

        return true;
    }
};